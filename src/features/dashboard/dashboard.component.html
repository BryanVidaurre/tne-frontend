
<div class="dashboard-header card mb-3">
  <div class="card-body">
    <div class="d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between">
      <div>
        <div class="page-title">Centro de carga TNE</div>
        <div class="text-muted">Valida los Excel antes de subirlos y sigue el orden recomendado.</div>
      </div>
      <div class="d-flex align-items-end gap-2">
        <div>
          <label class="form-label mb-1">Periodo</label>
          <input
            class="form-control"
            type="number"
            [(ngModel)]="periodo"
            [disabled]="isBusy('subir_todo','recalcular','enviar','descargar')"
          />
        </div>
        <button
          class="btn btn-outline-secondary"
          (click)="recalcular()"
          [disabled]="isBusy('recalcular','subir_todo')"
        >
          <span *ngIf="busy.recalcular" class="spinner-border spinner-border-sm me-2"></span>
          Recalcular estado
        </button>
        <button
          class="btn btn-primary"
          (click)="enviarCorreos()"
          [disabled]="isBusy('enviar','subir_todo')"
        >
          <span *ngIf="busy.enviar" class="spinner-border spinner-border-sm me-2"></span>
          Enviar correos
        </button>
        <button
          class="btn btn-primary"
          (click)="descargarReporte()"
          [disabled]="isBusy('descargar','subir_todo')"
        >
          <span *ngIf="busy.descargar" class="spinner-border spinner-border-sm me-2"></span>
          Descargar reporte
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="alert" class="alert" [class.alert-success]="alert.type === 'success'" [class.alert-danger]="alert.type === 'danger'" [class.alert-warning]="alert.type === 'warning'" [class.alert-info]="alert.type === 'info'">
  {{ alert.text }}
</div>

<div class="row g-3">
  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Subir archivos</span>
        <span *ngIf="busy.subir_todo" class="small text-muted">
          <span class="spinner-border spinner-border-sm me-2"></span>
          Ejecutando...
        </span>
      </div>

      <div class="card-body">
        <div class="upload-item">
          <div class="upload-header">
            <div>
              <div class="label">Matrícula (maestro)</div>
              <div class="text-muted small">Columnas requeridas: {{ requiredHeaders.matricula.join(', ') }}</div>
            </div>
            <span class="badge" [class.bg-danger]="fileErrors.matricula" [class.bg-success]="files.matricula && !fileErrors.matricula" [class.bg-secondary]="!files.matricula && !fileErrors.matricula">
              {{ fileErrors.matricula ? 'Error' : files.matricula ? 'Listo' : 'Pendiente' }}
            </span>
          </div>
          <div class="upload-body">
            <input type="file" (change)="onFile('matricula', $event)" [disabled]="isBusy('subir_todo','matricula')" />
            <div class="upload-meta">
              <div *ngIf="files.matricula" class="small">Archivo: <strong>{{ files.matricula?.name }}</strong></div>
              <div *ngIf="fileErrors.matricula" class="small text-danger">{{ fileErrors.matricula }}</div>
            </div>

          </div>
        </div>

        <div class="upload-item">
          <div class="upload-header">
            <div>
              <div class="label">Pagos (crea procesos)</div>
              <div class="text-muted small">Columnas requeridas: {{ requiredHeaders.pagos.join(', ') }}</div>
            </div>
            <span class="badge" [class.bg-danger]="fileErrors.pagos" [class.bg-success]="files.pagos && !fileErrors.pagos" [class.bg-secondary]="!files.pagos && !fileErrors.pagos">
              {{ fileErrors.pagos ? 'Error' : files.pagos ? 'Listo' : 'Pendiente' }}
            </span>
          </div>
          <div class="upload-body">
            <input type="file"  (change)="onFile('pagos', $event)" [disabled]="isBusy('subir_todo','pagos')" />
            <div class="upload-meta">
              <div *ngIf="files.pagos" class="small">Archivo: <strong>{{ files.pagos?.name }}</strong></div>
              <div *ngIf="fileErrors.pagos" class="small text-danger">{{ fileErrors.pagos }}</div>
            </div>

          </div>
        </div>

        <div class="upload-item">
          <div class="upload-header">
            <div>
              <div class="label">Reporte JUNAEB</div>
              <div class="text-muted small">Columnas requeridas: {{ requiredHeaders.junaeb.join(', ') }}</div>
            </div>
            <span class="badge" [class.bg-danger]="fileErrors.junaeb" [class.bg-success]="files.junaeb && !fileErrors.junaeb" [class.bg-secondary]="!files.junaeb && !fileErrors.junaeb">
              {{ fileErrors.junaeb ? 'Error' : files.junaeb ? 'Listo' : 'Pendiente' }}
            </span>
          </div>
          <div class="upload-body">
            <input type="file" (change)="onFile('junaeb', $event)" [disabled]="isBusy('subir_todo','junaeb')" />
            <div class="upload-meta">
              <div *ngIf="files.junaeb" class="small">Archivo: <strong>{{ files.junaeb?.name }}</strong></div>
              <div *ngIf="fileErrors.junaeb" class="small text-danger">{{ fileErrors.junaeb }}</div>
            </div>

          </div>
        </div>

        <div class="upload-item">
          <div class="upload-header">
            <div>
              <div class="label">Invitados (lista retiro)</div>
              <div class="text-muted small">Columnas requeridas: {{ requiredHeaders.invitados.join(', ') }}</div>
            </div>
            <span class="badge" [class.bg-danger]="fileErrors.invitados" [class.bg-success]="files.invitados && !fileErrors.invitados" [class.bg-secondary]="!files.invitados && !fileErrors.invitados">
              {{ fileErrors.invitados ? 'Error' : files.invitados ? 'Listo' : 'Pendiente' }}
            </span>
          </div>
          <div class="upload-body">
            <input type="file" (change)="onFile('invitados', $event)" [disabled]="isBusy('subir_todo','invitados')" />
            <div class="upload-meta">
              <div *ngIf="files.invitados" class="small">Archivo: <strong>{{ files.invitados?.name }}</strong></div>
              <div *ngIf="fileErrors.invitados" class="small text-danger">{{ fileErrors.invitados }}</div>
            </div>

          </div>
        </div>

        <div class="upload-item">
          <div class="upload-header">
            <div>
              <div class="label">Asistentes (retiro)</div>
              <div class="text-muted small">Columnas requeridas: {{ requiredHeaders.asistentes.join(', ') }}</div>
            </div>
            <span class="badge" [class.bg-danger]="fileErrors.asistentes" [class.bg-success]="files.asistentes && !fileErrors.asistentes" [class.bg-secondary]="!files.asistentes && !fileErrors.asistentes">
              {{ fileErrors.asistentes ? 'Error' : files.asistentes ? 'Listo' : 'Pendiente' }}
            </span>
          </div>
          <div class="upload-body">
            <input type="file" (change)="onFile('asistentes', $event)" [disabled]="isBusy('subir_todo','asistentes')" />
            <div class="upload-meta">
              <div *ngIf="files.asistentes" class="small">Archivo: <strong>{{ files.asistentes?.name }}</strong></div>
              <div *ngIf="fileErrors.asistentes" class="small text-danger">{{ fileErrors.asistentes }}</div>
            </div>

          </div>
        </div>

        <div class="order-hint">
          <div class="text-muted small">Orden recomendado:</div>
          <div class="order-steps">Matrícula → Pagos → JUNAEB → Invitados → Asistentes</div>
        </div>

        <button class="btn btn-success mt-3 w-100"
                (click)="subirTodoYCalcular()"
                [disabled]="isBusy('subir_todo','recalcular','enviar','descargar','matricula','pagos','junaeb','invitados','asistentes') || !!fileErrors.pagos">
          <span *ngIf="busy.subir_todo" class="spinner-border spinner-border-sm me-2"></span>
          Subir todo y calcular
        </button>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header">Resultados</div>
      <div class="card-body">
        <div *ngIf="results.length === 0" class="text-muted">Sin acciones aún.</div>
        <div *ngFor="let r of results" class="mb-2">
          <div class="d-flex justify-content-between">
            <div>
              <b>{{ r.tipo }}</b>
              <span class="badge ms-2" [class.bg-success]="r.ok" [class.bg-danger]="!r.ok">
                {{ r.ok ? 'OK' : 'ERROR' }}
              </span>
            </div>
          </div>
          <pre class="mt-1 p-2 bg-light border rounded small">{{ r.message }}</pre>
        </div>
      </div>
    </div>
  </div>
</div>
