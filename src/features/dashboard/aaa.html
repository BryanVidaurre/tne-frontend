<!-- dashboard.component.html (Angular Material) -->
<section class="hero">
  <mat-card class="hero-card" appearance="outlined">
    <div class="hero-grid">
      <div class="periodo">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Periodo</mat-label>
          <input
            matInput
            type="number"
            [(ngModel)]="periodo"
            [disabled]="isBusy('subir_todo', 'recalcular', 'enviar', 'descargar')"
          />
          <mat-hint>Ej: {{ new Date().getFullYear() }}</mat-hint>
        </mat-form-field>
      </div>

      <div class="hero-actions">
        <button mat-raised-button color="primary" (click)="enviarCorreos()" [disabled]="isBusy('enviar')">
          <mat-spinner *ngIf="busy.enviar" diameter="18"></mat-spinner>
          <span>{{ busy.enviar ? 'Enviando correos...' : 'Enviar correos' }}</span>
        </button>

        <button
          mat-raised-button
          color="primary"
          (click)="descargarReporte()"
          [disabled]="isBusy('descargar', 'subir_todo')"
        >
          <mat-spinner *ngIf="busy.descargar" diameter="18"></mat-spinner>
          <span>{{ busy.descargar ? 'Generando reporte...' : 'Descargar reporte' }}</span>
        </button>
      </div>
    </div>
  </mat-card>
</section>

<div class="main-grid">
  <!-- IZQUIERDA -->
  <mat-card class="left" appearance="outlined">
    <mat-card-header>
      <mat-card-title>Subida de archivos</mat-card-title>
      <mat-card-subtitle>
        <span *ngIf="busy.subir_todo" class="inline-status">
          <mat-spinner diameter="16"></mat-spinner>
          <span>Ejecutando...</span>
        </span>
      </mat-card-subtitle>
    </mat-card-header>

    <mat-divider></mat-divider>

    <mat-card-content class="upload-stack">
      <!-- PANEL (reutiliza markup con ng-container por tipo) -->
      <div class="upload-panel" *ngFor="let tipo of ['matricula','pagos','junaeb','invitados','asistentes']">
        <div class="panel-head">
          <div class="panel-title">
            <div class="label">{{ pretty(tipo) }}</div>
            <div class="desc" [ngSwitch]="tipo">
              <span *ngSwitchCase="'matricula'">Incluye los datos principales de estudiantes.</span>
              <span *ngSwitchCase="'pagos'">Define quién pagó y habilita el flujo.</span>
              <span *ngSwitchCase="'junaeb'">Estado oficial del proceso y fechas asociadas.</span>
              <span *ngSwitchCase="'invitados'">Marca quienes están habilitados para retiro.</span>
              <span *ngSwitchCase="'asistentes'">Confirma retiros presenciales y medio de ingreso.</span>
            </div>
          </div>

          <mat-chip
            class="status-chip"
            [ngClass]="{
              'chip-error': (fileErrors as any)[tipo],
              'chip-ready': (files as any)[tipo] && !(fileErrors as any)[tipo]
            }"
          >
            <mat-icon *ngIf="(fileErrors as any)[tipo]">error</mat-icon>
            <mat-icon *ngIf="(files as any)[tipo] && !(fileErrors as any)[tipo]">check_circle</mat-icon>
            <mat-icon *ngIf="!(files as any)[tipo]">schedule</mat-icon>
            {{ (fileErrors as any)[tipo] ? 'Error' : (files as any)[tipo] ? 'Listo' : 'Pendiente' }}
          </mat-chip>
        </div>

        <div class="panel-body">
          <div class="file-row">
            <input
              #fileInput
              class="file-hidden"
              type="file"
              (change)="onFile(tipo as any, $event)"
              [disabled]="isBusy('subir_todo', tipo as any)"
            />

            <button
              mat-stroked-button
              color="primary"
              type="button"
              (click)="fileInput.click()"
              [disabled]="isBusy('subir_todo', tipo as any)"
            >
              <mat-icon>upload_file</mat-icon>
              Seleccionar Excel
            </button>

            <button
              mat-icon-button
              type="button"
              matTooltip="Quitar archivo"
              (click)="clearFile(tipo as any, fileInput)"
              [disabled]="!(files as any)[tipo] || isBusy('subir_todo', tipo as any)"
            >
              <mat-icon>close</mat-icon>
            </button>

            <div class="file-meta" *ngIf="(files as any)[tipo]">
              <div class="file-name">{{ (files as any)[tipo]?.name }}</div>
              <div class="file-hint">Listo para subir</div>
            </div>
          </div>

          <div class="req">
            <div class="req-title">Columnas requeridas</div>
            <mat-chip-set class="chipset">
              <mat-chip *ngFor="let h of (requiredHeaders as any)[tipo]" disableRipple>{{ h }}</mat-chip>
            </mat-chip-set>
          </div>

          <div class="err" *ngIf="(fileErrors as any)[tipo]">
            <mat-icon>warning</mat-icon>
            <span>{{ (fileErrors as any)[tipo] }}</span>
          </div>

          <div class="panel-actions">
            <button
              mat-raised-button
              color="accent"
              type="button"
              (click)="upload(tipo as any)"
              [disabled]="isBusy('subir_todo', tipo as any) || !(files as any)[tipo]"
            >
              <mat-spinner *ngIf="(busy as any)[tipo]" diameter="18"></mat-spinner>
              <span>{{ (busy as any)[tipo] ? 'Subiendo...' : 'Subir' }}</span>
            </button>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <div class="footer">
        <div class="order">
          <div class="muted">Orden recomendado</div>
          <div class="steps">Matrícula → Pagos → JUNAEB → Invitados → Asistentes</div>
        </div>

        <button
          mat-raised-button
          color="primary"
          type="button"
          (click)="subirTodoYCalcular()"
          [disabled]="
            isBusy(
              'subir_todo','recalcular','enviar','descargar',
              'matricula','pagos','junaeb','invitados','asistentes'
            )
          "
        >
          <mat-spinner *ngIf="busy.subir_todo" diameter="18"></mat-spinner>
          <span>{{ busy.subir_todo ? 'Procesando...' : 'Subir todo y calcular' }}</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- DERECHA -->
  <mat-card class="right" appearance="outlined">
    <mat-card-header>
      <mat-card-title>Actividad reciente</mat-card-title>
      <mat-card-subtitle>Resultados de acciones y validaciones</mat-card-subtitle>
    </mat-card-header>

    <mat-divider></mat-divider>

    <mat-card-content class="results">
      <div *ngIf="results.length === 0" class="empty">
        <mat-icon>description</mat-icon>
        <div>Sin acciones aún.</div>
        <div class="muted">Sube tu primer archivo para ver resultados aquí.</div>
      </div>

      <div *ngFor="let r of results" class="result-item">
        <div class="result-head">
          <div class="result-title">
            <strong>{{ pretty(r.tipo) }}</strong>
          </div>
          <mat-chip [ngClass]="{ 'chip-ready': r.ok, 'chip-error': !r.ok }">
            <mat-icon>{{ r.ok ? 'check_circle' : 'error' }}</mat-icon>
            {{ r.ok ? 'OK' : 'Error' }}
          </mat-chip>
        </div>
        <pre class="result-body">{{ r.message }}</pre>
      </div>
    </mat-card-content>
  </mat-card>
</div>
